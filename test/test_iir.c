#include <unity.h>
#include "iir.h"

#define ARRAY_SIZE(x) (sizeof(x) / sizeof(x[0]))

#define EPSILON 1e-6

struct point {
    float x;
    float y;
};

const struct point test_data[] = {
    { .x = 1.0, .y = 0.06466651396736318 },
    { .x = 0.0, .y = 0.20477603165515357 },
    { .x = 0.0, .y = 0.27606822208865234 },
    { .x = 0.0, .y = 0.23497754336130058 },
    { .x = 0.0, .y = 0.1567112678326538 },
    { .x = 0.0, .y = 0.08287817623206084 },
    { .x = 0.0, .y = 0.03003099657223529 },
    { .x = 0.0, .y = -0.0002179775707124021 },
    { .x = 0.0, .y = -0.013028911117714209 },
    { .x = 0.0, .y = -0.015107940766479928 },
    { .x = 0.0, .y = -0.012083997152074154 },
    { .x = 0.0, .y = -0.007671622153868113 },
    { .x = 0.0, .y = -0.003810087167024359 },
    { .x = 0.0, .y = -0.0011818217811165894 },
    { .x = 0.0, .y = 0.00024192029886018753 },
    { .x = 0.0, .y = 0.0007849692284064554 },
    { .x = 0.0, .y = 0.0008129054007879209 },
    { .x = 0.0, .y = 0.0006144957667477989 },
    { .x = 0.0, .y = 0.0003711302790517871 },
    { .x = 0.0, .y = 0.00017159845694094322 },
    { .x = 0.0, .y = 4.233015474019831e-05 },
    { .x = 0.0, .y = -2.360858165386319e-05 },
    { .x = 0.0, .y = -4.55502518032236e-05 },
    { .x = 0.0, .y = -4.3100267327928807e-05 },
    { .x = 0.0, .y = -3.090834375145115e-05 },
};

void
test_iir2_apply(void)
{
    struct iir2 f = {
        .a = { -1.16668723, 0.42538047 },
        .b = { 0.06466651, 0.12933044, 0.06466651 },
    };

    float dl[2] = { 0 };

    for (int i = 0; i < ARRAY_SIZE(test_data); i++) {
        float y = iir2_apply(&f, dl, test_data[i].x);
        TEST_ASSERT_FLOAT_WITHIN(EPSILON, test_data[i].y, y);
    }
}

static const struct point test_allpass[] = {
    { .x = 1.0, .y = 0.7 },
    { .x = 0.0, .y = 0.4500000000000002 },
    { .x = 0.0, .y = -0.16500000000000026 },
    { .x = 0.0, .y = -0.06749999999999973 },
    { .x = 0.0, .y = 0.21674999999999978 },
    { .x = 0.0, .y = -0.27787499999999987 },
    { .x = 0.0, .y = 0.2650875 },
    { .x = 0.0, .y = -0.2031187500000001 },
    { .x = 0.0, .y = 0.11911687500000015 },
    { .x = 0.0, .y = -0.03649218750000019 },
    { .x = 0.0, .y = -0.028643531249999812 },
    { .x = 0.0, .y = 0.06850982812499985 },
    { .x = 0.0, .y = -0.08271427031249992 },
    { .x = 0.0, .y = 0.07611452578125 },
    { .x = 0.0, .y = -0.056271799453125056 },
    { .x = 0.0, .y = 0.031127531132812594 },
    { .x = 0.0, .y = -0.007301037082031357 },
    { .x = 0.0, .y = -0.010837716169921779 },
    { .x = 0.0, .y = 0.021367300212304617 },
    { .x = 0.0, .y = -0.024464548999511677 },
    { .x = 0.0, .y = 0.02173971335065429 },
    { .x = 0.0, .y = -0.015484385726323265 },
    { .x = 0.0, .y = 0.008008779244026893 },
    { .x = 0.0, .y = -0.0011740988576140546 },
    { .x = 0.0, .y = -0.003844997184397743 },
    { .x = 0.0, .y = 0.006589364976926452 },
    { .x = 0.0, .y = -0.007192549436311258 },
    { .x = 0.0, .y = 0.006176268670618371 },
    { .x = 0.0, .y = -0.004229618400509676 },
    { .x = 0.0, .y = 0.0020210395313316545 },
};

void
test_biquad_allpass(void)
{
    const float c3 = 0.7;
    const float c2 = 1.5;
    float       dl[2] = { 0 };

    for (int i = 0; i < ARRAY_SIZE(test_allpass); i++) {
        float y = ap2_apply(c3, c2, dl, test_allpass[i].x);
        TEST_ASSERT_FLOAT_WITHIN(EPSILON, test_allpass[i].y, y);
    }
}

static const struct point test_dc[] = {
    { .x = 0.5, .y = 0.5 },
    { .x = 0.5376901826699345, .y = 0.5361901826699345 },
    { .x = 0.5753268055279327, .y = 0.5722182349799229 },
    { .x = 0.6128563848734817, .y = 0.6080311596205321 },
    { .x = 0.6502255891207571, .y = 0.6435762703889459 },
    { .x = 0.6873813145857246, .y = 0.6788012670427466 },
    { .x = 0.7242707609493811, .y = 0.7136543096052749 },
    { .x = 0.7608415062898969, .y = 0.7480840920169748 },
    { .x = 0.7970415815770349, .y = 0.7820399150280618 },
    { .x = 0.8328195445229867, .y = 0.8154717582289295 },
    { .x = 0.8681245526846779, .y = 0.8483303511159339 },
    { .x = 0.9029064357136627, .y = 0.8805672430915709 },
    { .x = 0.9371157666509329, .y = 0.9121348722995664 },
    { .x = 0.9707039321653326, .y = 0.9429866331970673 },
    { .x = 1.0036232016357607, .y = 0.9730769427679042 },
    { .x = 1.0358267949789965, .y = 1.0023613052828364 },
    { .x = 1.0672689491267566, .y = 1.030796375514748 },
    { .x = 1.0979049830575187, .y = 1.058340020318966 },
    { .x = 1.1276913612907005, .y = 1.0849513784911908 },
    { .x = 1.1565857557529564, .y = 1.1105909188179732 },
    { .x = 1.1845471059286887, .y = 1.1352204962372516 },
    { .x = 1.2115356772092853, .y = 1.1588034060291366 },
    { .x = 1.237513117358174, .y = 1.1813044359599378 },
    { .x = 1.2624425110114479, .y = 1.202689916305332 },
    { .x = 1.2862884321366188, .y = 1.2229277676815868 },
    { .x = 1.3090169943749475, .y = 1.2419875466168708 },
    { .x = 1.3305958991958127, .y = 1.2598404887978853 },
    { .x = 1.3509944817946917, .y = 1.2764595499303708 },
    { .x = 1.3701837546695255, .y = 1.2918194441554134 },
    { .x = 1.3881364488135444, .y = 1.305896679966966 },
    { .x = 1.4048270524660196, .y = 1.3186695935795403 },
    { .x = 1.4202318473658704, .y = 1.3301183796986524 },
    { .x = 1.4343289424566121, .y = 1.3402251196502981 },
    { .x = 1.4470983049947441, .y = 1.3489738068294792 },
    { .x = 1.4585217890173758, .y = 1.3563503694316226 },
    { .x = 1.468583161128631, .y = 1.362342690434583 },
    { .x = 1.4772681235681935, .y = 1.3669406248028417 },
    { .x = 1.4845643345292054, .y = 1.3701360138894452 },
    { .x = 1.490461425696651, .y = 1.3719226970152225 },
    { .x = 1.4949510169813003, .y = 1.372296520208826 },
    { .x = 1.4980267284282716, .y = 1.3712553420951707 },
    { .x = 1.4996841892833, .y = 1.3687990369239136 },
    { .x = 1.4999210442038162, .y = 1.364929494733658 },
    { .x = 1.4987369566060176, .y = 1.3596506186516584 },
    { .x = 1.4961336091431725, .y = 1.3529683193328583 },
    { .x = 1.4921147013144778, .y = 1.344890506546165 },
    { .x = 1.4866859442078681, .y = 1.3354270779199169 },
    { .x = 1.4798550523842469, .y = 1.3245899048625358 },
    { .x = 1.471631732914674, .y = 1.3123928156783753 },
    { .x = 1.4620276715860858, .y = 1.298851575902752 },
    { .x = 1.4510565162951536, .y = 1.2839838658841114 },
    { .x = 1.4387338576538742, .y = 1.2678092556451797 },
    { .x = 1.425077206834458, .y = 1.2503491770588278 },
    { .x = 1.4101059706849957, .y = 1.231626893378189 },
    { .x = 1.393841424151264, .y = 1.211667466164323 },
    { .x = 1.3763066800438635, .y = 1.1904977196584294 },
    { .x = 1.3575266561936523, .y = 1.168146202649243 },
    { .x = 1.3375280400421419, .y = 1.144643147889785 },
    { .x = 1.316339250717184, .y = 1.1200204291211577 },
    { .x = 1.2939903986478356, .y = 1.0943115157644459 },
    { .x = 1.2705132427757893, .y = 1.0675514253451062 },
    { .x = 1.2459411454241822, .y = 1.0397766737174639 },
    { .x = 1.2203090248879067, .y = 1.0110252231600358 },
    { .x = 1.1936533058128052, .y = 0.9813364284154542 },
    { .x = 1.1660118674342517, .y = 0.9507509807516543 },
    { .x = 1.1374239897486897, .y = 0.9193108501238374 },
    { .x = 1.1079302976946055, .y = 0.8870592255193817 },
    { .x = 1.0775727034222675, .y = 0.8540404535704855 },
    { .x = 1.0463943467342691, .y = 0.8202999755217757 },
    { .x = 1.0144395337815064, .y = 0.7858842626424477 },
    { .x = 0.9817536741017157, .y = 0.7508407501747296 },
    { .x = 0.9483832160900323, .y = 0.7152177699125221 },
    { .x = 0.9143755809932843, .y = 0.6790644815060365 },
    { .x = 0.8797790955218014, .y = 0.6424308025900355 },
};

void
test_dc_block(void)
{
    const float b = 0.997;
    float       dl[2] = {0};

    for (int i = 0; i < ARRAY_SIZE(test_allpass); i++) {
        float y = dc_block(b, dl, test_dc[i].x);
        TEST_ASSERT_FLOAT_WITHIN(EPSILON, test_dc[i].y, y);
    }
}
