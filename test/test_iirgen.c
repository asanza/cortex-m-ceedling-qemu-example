#include <unity.h>
#include "iir.h"

#define ARRAY_SIZE(x) (sizeof(x) / sizeof(x[0]))

#define EPSILON 1e-6

struct point {
    float x;
    float y;
};

static const struct iir2 f = {
    .a = { -1.4523879349634015, 0.5774789842285108 },
    .b = { 0.038811446233767505, 0.047324223275615813, 0.038811446233767505 },
};
static const struct point test_data[] = {
    { .x =  0.00000000, .y =  0.00000000},
    { .x =  0.22043889, .y =  0.00855555},
    { .x =  0.30746841, .y =  0.03479137},
    { .x =  0.30934603, .y =  0.08070234},
    { .x =  0.38664802, .y =  0.13869904},
    { .x =  0.58778525, .y =  0.20795769},
    { .x =  0.77965276, .y =  0.29502176},
    { .x =  0.82929177, .y =  0.40029012},
    { .x =  0.78554940, .y =  0.51100102},
    { .x =  0.80972140, .y =  0.61180057},
    { .x =  0.95105652, .y =  0.69919904},
    { .x =  1.07739290, .y =  0.78045593},
    { .x =  1.05680525, .y =  0.85866682},
    { .x =  0.93924820, .y =  0.92470168},
    { .x =  0.88718160, .y =  0.96706165},
    { .x =  0.95105652, .y =  0.98590353},
    { .x =  0.99993270, .y =  0.99170626},
    { .x =  0.90310645, .y =  0.99028742},
    { .x =  0.71173472, .y =  0.97476308},
    { .x =  0.58944145, .y =  0.93547420},
    { .x =  0.58778525, .y =  0.87409735},
    { .x =  0.57685933, .y =  0.80239406},
    { .x =  0.42690308, .y =  0.72729554},
    { .x =  0.18991136, .y =  0.64291190},
    { .x =  0.03022758, .y =  0.54048890},
    { .x =  0.00000000, .y =  0.42253269},
    { .x = -0.03022758, .y =  0.30156039},
    { .x = -0.18991136, .y =  0.18517770},
    { .x = -0.42690308, .y =  0.06807575},
    { .x = -0.57685933, .y = -0.05802616},
    { .x = -0.58778525, .y = -0.19026975},
    { .x = -0.58944145, .y = -0.31591891},
    { .x = -0.71173472, .y = -0.42729113},
    { .x = -0.90310645, .y = -0.52976619},
    { .x = -0.99993270, .y = -0.63184548},
    { .x = -0.95105652, .y = -0.73103969},
    { .x = -0.88718160, .y = -0.81512539},
    { .x = -0.93924820, .y = -0.87706886},
    { .x = -1.05680525, .y = -0.92302458},
    { .x = -1.07739290, .y = -0.96238218},
    { .x = -0.95105652, .y = -0.99363977},
    { .x = -0.80972140, .y = -1.00564457},
    { .x = -0.78554940, .y = -0.99249959},
    { .x = -0.82929177, .y = -0.96154380},
    { .x = -0.77965276, .y = -0.92338031},
    { .x = -0.58778525, .y = -0.87773036},
    { .x = -0.38664802, .y = -0.81465456},
    { .x = -0.30934603, .y = -0.72944040},
    { .x = -0.30746841, .y = -0.63056377},
    { .x = -0.22043889, .y = -0.52969913},
    { .x = -0.00000000, .y = -0.42755669},
    { .x =  0.22043889, .y = -0.31508807},
    { .x =  0.30746841, .y = -0.18835971},
    { .x =  0.30934603, .y = -0.05650221},
    { .x =  0.38664802, .y =  0.06828987},
    { .x =  0.58778525, .y =  0.18492900},
    { .x =  0.77965276, .y =  0.30223498},
    { .x =  0.82929177, .y =  0.42406510},
    { .x =  0.78554940, .y =  0.54136604},
    { .x =  0.80972140, .y =  0.64217280},
    { .x =  0.95105652, .y =  0.72577614},
    { .x =  1.07739290, .y =  0.80151686},
    { .x =  1.05680525, .y =  0.87390775},
    { .x =  0.93924820, .y =  0.93467518},
    { .x =  0.88718160, .y =  0.97274572},
    { .x =  0.95105652, .y =  0.98839952},
    { .x =  0.99993270, .y =  0.99204897},
    { .x =  0.90310645, .y =  0.98934379},
    { .x =  0.71173472, .y =  0.97319465},
    { .x =  0.58944145, .y =  0.93374116},
    { .x =  0.58778525, .y =  0.87248604},
    { .x =  0.57685933, .y =  0.80105461},
    { .x =  0.42690308, .y =  0.72628063},
    { .x =  0.18991136, .y =  0.64221137},
    { .x =  0.03022758, .y =  0.54005755},
    { .x = -0.00000000, .y =  0.42231073},
    { .x = -0.03022758, .y =  0.30148712},
    { .x = -0.18991136, .y =  0.18519946},
    { .x = -0.42690308, .y =  0.06814967},
    { .x = -0.57685933, .y = -0.05793137},
    { .x = -0.58778525, .y = -0.19017477},
    { .x = -0.58944145, .y = -0.31583569},
    { .x = -0.71173472, .y = -0.42722512},
    { .x = -0.90310645, .y = -0.52971837},
    { .x = -0.99993270, .y = -0.63181415},
    { .x = -0.95105652, .y = -0.73102180},
    { .x = -0.88718160, .y = -0.81511750},
    { .x = -0.93924820, .y = -0.87706773},
    { .x = -1.05680525, .y = -0.92302750},
    { .x = -1.07739290, .y = -0.96238707},
    { .x = -0.95105652, .y = -0.99364518},
    { .x = -0.80972140, .y = -1.00564962},
    { .x = -0.78554940, .y = -0.99250378},
    { .x = -0.82929177, .y = -0.96154699},
    { .x = -0.77965276, .y = -0.92338251},
    { .x = -0.58778525, .y = -0.87773172},
    { .x = -0.38664802, .y = -0.81465526},
    { .x = -0.30934603, .y = -0.72944063},
    { .x = -0.30746841, .y = -0.63056370},
    { .x = -0.22043889, .y = -0.52969890},
};

void
test_iir2_apply(void)
{
    float dl[2] = { 0 };
    for (int i = 0; i < ARRAY_SIZE(test_data); i++) {
        float y = iir2_apply(&f, dl, test_data[i].x);
        TEST_ASSERT_FLOAT_WITHIN(EPSILON, test_data[i].y, y);
    }
}
